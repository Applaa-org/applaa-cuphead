<!DOCTYPE html>
<html>
<head>
    <title>Cuphead: Rubber-Hose Rampage</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: #f0e6d2; font-family: 'Courier New', Courier, monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        canvas { border: 10px solid #333; background: #d2b48c; image-rendering: pixelated; box-shadow: 0 0 30px rgba(0,0,0,0.8); }
        #hud { position: absolute; top: 20px; width: 780px; display: flex; justify-content: space-between; font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        #film-grain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.15; animation: grain 0.1s steps(2) infinite; }
        @keyframes grain { from { transform: translate(0,0); } to { transform: translate(-5px, -5px); } }
        .menu { position: absolute; background: rgba(40, 20, 10, 0.95); padding: 40px; border: 6px double #f0e6d2; text-align: center; width: 400px; }
        button { background: #f0e6d2; border: 3px solid #333; padding: 12px 24px; font-size: 20px; cursor: pointer; margin: 10px; font-family: inherit; font-weight: bold; }
        button:hover { background: #ffcc00; transform: scale(1.05); }
        input { padding: 10px; width: 80%; margin-bottom: 20px; font-family: inherit; font-size: 18px; text-align: center; }
    </style>
</head>
<body>
    <div id="film-grain"></div>
    <div id="hud">
        <div id="scoreDisplay">SCORE: 00000</div>
        <div id="highScoreDisplay">BEST: 0</div>
    </div>

    <canvas id="gameCanvas" width="800" height="450"></canvas>

    <div id="startMenu" class="menu">
        <h1 style="margin-top:0; color:#ff4444;">RUBBER-HOSE RAMPAGE</h1>
        <p>WASD: Move/Aim | SPACE: Jump/Parry<br>SHIFT: Dash | CLICK: Shoot</p>
        <input type="text" id="playerNameInput" placeholder="Enter Name" maxlength="12">
        <button onclick="startGame()">START GAME</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameId = 'cuphead_rubber_hose_v1';
        
        let score = 0;
        let highScore = 0;
        let gameActive = false;
        let player = { x: 100, y: 350, vy: 0, w: 40, h: 60 };
        let enemies = [];

        // MANDATORY: Initialize High Score to 0
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('highScoreDisplay').textContent = 'BEST: 0';
            // Load from Applaa Storage
            window.parent.postMessage({ type: 'applaa-game-load-data', gameId: gameId }, '*');
        });

        // Listen for Storage Response
        window.addEventListener('message', (event) => {
            if (event.data.type === 'applaa-game-data-loaded') {
                const data = event.data.data;
                if (data) {
                    highScore = data.highScore || 0;
                    document.getElementById('highScoreDisplay').textContent = 'BEST: ' + highScore;
                    if (data.lastPlayerName) document.getElementById('playerNameInput').value = data.lastPlayerName;
                }
            }
        });

        function startGame() {
            document.getElementById('startMenu').style.display = 'none';
            gameActive = true;
            score = 0;
            loop();
        }

        function loop() {
            if (!gameActive) return;
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            player.y += player.vy;
            if (player.y < 350) player.vy += 0.6;
            else { player.y = 350; player.vy = 0; }

            if (Math.random() < 0.03) enemies.push({ x: 850, y: 350, s: 4 + (score/1000) });

            enemies.forEach((e, i) => {
                e.x -= e.s;
                if (e.x < player.x + player.w && e.x + 30 > player.x && e.y < player.y + player.h && e.y + 30 > player.y) {
                    endGame();
                }
            });

            score += 1;
            document.getElementById('scoreDisplay').textContent = 'SCORE: ' + score.toString().padStart(5, '0');
            if (score > highScore) {
                document.getElementById('highScoreDisplay').textContent = 'BEST: ' + score;
            }
        }

        function draw() {
            ctx.fillStyle = '#d2b48c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ground
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(0, 410, canvas.width, 40);

            // Player (Rubber hose jitter)
            ctx.fillStyle = '#333';
            const jX = Math.random() * 2 - 1;
            const jY = Math.random() * 2 - 1;
            ctx.fillRect(player.x + jX, player.y + jY, player.w, player.h);
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.fillRect(player.x + 25, player.y + 10, 10, 15);
            ctx.fillStyle = 'black';
            ctx.fillRect(player.x + 30, player.y + 15, 4, 4);

            // Enemies
            ctx.fillStyle = '#800';
            enemies.forEach(e => ctx.fillRect(e.x, e.y, 30, 30));
        }

        function endGame() {
            gameActive = false;
            const name = document.getElementById('playerNameInput').value || 'Cuphead';
            
            // Save to Applaa Storage
            window.parent.postMessage({ 
                type: 'applaa-game-save-score', 
                gameId: gameId, 
                playerName: name, 
                score: score 
            }, '*');

            alert('KNOCKOUT! Final Score: ' + score);
            location.reload();
        }

        window.addEventListener('keydown', e => {
            if (e.code === 'Space' && player.y >= 350) player.vy = -14;
        });
    </script>
</body>
</html>