<!DOCTYPE html>
<html>
<head>
    <title>Cuphead: Rubber-Hose Rampage</title>
    <style>
        body { margin: 0; background: #222; color: #f0e6d2; font-family: 'Courier New', Courier, monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        canvas { border: 8px solid #444; background: #d2b48c; image-rendering: pixelated; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #ui { position: absolute; top: 20px; width: 800px; display: flex; justify-content: space-between; font-weight: bold; text-shadow: 2px 2px #000; }
        #film-grain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.1; animation: grain 0.2s steps(2) infinite; }
        @keyframes grain { from { transform: translate(0,0); } to { transform: translate(-5px, -5px); } }
        .menu { position: absolute; background: rgba(0,0,0,0.8); padding: 40px; border: 4px solid #f0e6d2; text-align: center; }
        button { background: #f0e6d2; border: none; padding: 10px 20px; font-size: 20px; cursor: pointer; margin: 10px; font-family: inherit; }
        button:hover { background: #ffcc00; transform: scale(1.1); }
    </style>
</head>
<body>
    <div id="film-grain"></div>
    <div id="ui">
        <div id="score">SCORE: 00000</div>
        <div id="highScoreDisplay">HIGH SCORE: 0</div>
        <div id="hp">HP: ❤️❤️❤️</div>
    </div>

    <canvas id="gameCanvas" width="800" height="450"></canvas>

    <div id="startMenu" class="menu">
        <h1>RUBBER-HOSE RAMPAGE</h1>
        <p>WASD: Move/Aim | SPACE: Jump | SHIFT: Dash | CLICK: Shoot</p>
        <input type="text" id="playerNameInput" placeholder="Enter Name" style="padding: 10px; margin-bottom: 10px;"><br>
        <button onclick="startGame()">START GAME</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameId = 'cuphead-clone-v1';
        
        let score = 0;
        let highScore = 0;
        let hp = 3;
        let gameActive = false;
        let player = { x: 100, y: 350, vx: 0, vy: 0, w: 40, h: 60, color: '#333' };
        let enemies = [];
        let bullets = [];

        // Persistence Initialization
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('highScoreDisplay').textContent = 'HIGH SCORE: 0';
            window.parent.postMessage({ type: 'applaa-game-load-data', gameId: gameId }, '*');
        });

        window.addEventListener('message', (event) => {
            if (event.data.type === 'applaa-game-data-loaded') {
                const data = event.data.data;
                if (data) {
                    highScore = data.highScore || 0;
                    document.getElementById('highScoreDisplay').textContent = 'HIGH SCORE: ' + highScore;
                    if (data.lastPlayerName) document.getElementById('playerNameInput').value = data.lastPlayerName;
                }
            }
        });

        function startGame() {
            document.getElementById('startMenu').style.display = 'none';
            gameActive = true;
            score = 0;
            hp = 3;
            loop();
        }

        function loop() {
            if (!gameActive) return;
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            // Simple physics
            player.y += player.vy;
            if (player.y < 350) player.vy += 0.5;
            else { player.y = 350; player.vy = 0; }

            // Spawn enemies
            if (Math.random() < 0.02) enemies.push({ x: 850, y: 350, s: 3 });

            enemies.forEach((e, i) => {
                e.x -= e.s;
                if (e.x < player.x + player.w && e.x + 30 > player.x && e.y < player.y + player.h && e.y + 30 > player.y) {
                    hp--;
                    enemies.splice(i, 1);
                    if (hp <= 0) endGame();
                }
            });

            score++;
            document.getElementById('score').textContent = 'SCORE: ' + score.toString().padStart(5, '0');
            document.getElementById('hp').textContent = 'HP: ' + '❤️'.repeat(hp);
        }

        function draw() {
            ctx.fillStyle = '#d2b48c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Ground
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(0, 410, canvas.width, 40);

            // Player (Rubber hose jitter)
            const jitterX = Math.random() * 2 - 1;
            const jitterY = Math.random() * 2 - 1;
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x + jitterX, player.y + jitterY, player.w, player.h);
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.fillRect(player.x + 25, player.y + 10, 10, 15);
            ctx.fillStyle = 'black';
            ctx.fillRect(player.x + 30, player.y + 15, 4, 4);

            // Enemies
            ctx.fillStyle = '#800';
            enemies.forEach(e => ctx.fillRect(e.x, e.y, 30, 30));
        }

        function endGame() {
            gameActive = false;
            const name = document.getElementById('playerNameInput').value || 'Cuphead';
            window.parent.postMessage({ 
                type: 'applaa-game-save-score', 
                gameId: gameId, 
                playerName: name, 
                score: score 
            }, '*');
            alert('GAME OVER! Score: ' + score);
            location.reload();
        }

        window.addEventListener('keydown', e => {
            if (e.code === 'Space' && player.y >= 350) player.vy = -12;
        });
    </script>
</body>
</html>